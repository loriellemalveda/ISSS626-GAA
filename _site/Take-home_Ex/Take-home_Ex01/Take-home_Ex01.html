<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lorielle Malveda">
<meta name="dcterms.date" content="2024-09-09">

<title>Take-Home Exercise 1 – ISSS626-GAA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ISSS626-GAA</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hands-on-exercise" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Hands-on Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-hands-on-exercise">    
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex01_01/Hands-on_Ex01_01.html">
 <span class="dropdown-text">Hands-on Exercise 1: Part 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex01_02/Hands-on_Ex01_02.html">
 <span class="dropdown-text">Hands-on Exercise 1: Part 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex02_01/Hands-on_Ex02_01.html">
 <span class="dropdown-text">Hands-on Exercise 2: Part 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex02_02/Hands-on_Ex02_02.html">
 <span class="dropdown-text">Hands-on Exercise 2: Part 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex03/Hands-on_Ex03.html">
 <span class="dropdown-text">Hands-on Exercise 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex04/Hands-on_Ex04.html">
 <span class="dropdown-text">Hands-on Exercise 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex05_01/Hands-on_Ex05_01.html">
 <span class="dropdown-text">Hands-on Exercise 5: Part 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex05_02/Hands-on_Ex05_02.html">
 <span class="dropdown-text">Hands-on Exercise 5: Part 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex06/Hands-on_Ex06.html">
 <span class="dropdown-text">Hands-on Exercise 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex07/Hands-on_Ex07.html">
 <span class="dropdown-text">Hands-on Exercise 7</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex08/Hands-on_Ex08.html">
 <span class="dropdown-text">Hands-on Exercise 8</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex09/Hands-on_Ex09.html">
 <span class="dropdown-text">Hands-on Exercise 9</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex10_01/Hands-on_Ex10_01.html">
 <span class="dropdown-text">Hands-on Exercise 10: Part 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex10_02/Hands-on_Ex10_02.html">
 <span class="dropdown-text">Hands-on Exercise 10: Part 2</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-in-class-exercise" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">In-class Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-in-class-exercise">    
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex01/In-class_Ex01.html">
 <span class="dropdown-text">In-class Exercise 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex02/In-class_Ex02.html">
 <span class="dropdown-text">In-class Exercise 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex03/In-class_Ex03.html">
 <span class="dropdown-text">In-class Exercise 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex04/In-class_Ex04.html">
 <span class="dropdown-text">In-class Exercise 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex05/In-class_Ex05.html">
 <span class="dropdown-text">In-class Exercise 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex06/In-class_Ex06.html">
 <span class="dropdown-text">In-class Exercise 6</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex07/In-class_Ex07.html">
 <span class="dropdown-text">In-class Exercise 7</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex08/In-class_Ex08.html">
 <span class="dropdown-text">In-class Exercise 8</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex09/In-class_Ex09.html">
 <span class="dropdown-text">In-class Exercise 9</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-take-home-exercise" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Take-home Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-take-home-exercise">    
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex01/Take-home_Ex01.html">
 <span class="dropdown-text">Take-home Exercise 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex02/Take-home_Ex02.html">
 <span class="dropdown-text">Take-home Exercise 2</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">1. OVERVIEW</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">2. GETTING STARTED</a>
  <ul class="collapse">
  <li><a href="#installing-the-r-packages" id="toc-installing-the-r-packages" class="nav-link" data-scroll-target="#installing-the-r-packages">2.1 Installing the R Packages</a></li>
  <li><a href="#importing-the-datasets" id="toc-importing-the-datasets" class="nav-link" data-scroll-target="#importing-the-datasets">2.2 Importing the Datasets</a>
  <ul class="collapse">
  <li><a href="#boundaries-data" id="toc-boundaries-data" class="nav-link" data-scroll-target="#boundaries-data">BOUNDARIES DATA</a></li>
  <li><a href="#road-accident-data" id="toc-road-accident-data" class="nav-link" data-scroll-target="#road-accident-data">ROAD ACCIDENT DATA</a></li>
  <li><a href="#road-network-data" id="toc-road-network-data" class="nav-link" data-scroll-target="#road-network-data">ROAD NETWORK DATA</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#geospatial-data-wrangling" id="toc-geospatial-data-wrangling" class="nav-link" data-scroll-target="#geospatial-data-wrangling">3. GEOSPATIAL DATA WRANGLING</a>
  <ul class="collapse">
  <li><a href="#changing-coordinate-systems" id="toc-changing-coordinate-systems" class="nav-link" data-scroll-target="#changing-coordinate-systems">3.1 CHANGING COORDINATE SYSTEMS</a></li>
  <li><a href="#road-accident-data-1" id="toc-road-accident-data-1" class="nav-link" data-scroll-target="#road-accident-data-1">3.2 ROAD ACCIDENT DATA</a></li>
  <li><a href="#boundaries-data-1" id="toc-boundaries-data-1" class="nav-link" data-scroll-target="#boundaries-data-1">3.3 BOUNDARIES DATA</a></li>
  <li><a href="#road-network-data-1" id="toc-road-network-data-1" class="nav-link" data-scroll-target="#road-network-data-1">3.4 ROAD NETWORK DATA</a></li>
  <li><a href="#saving-and-writing-rds" id="toc-saving-and-writing-rds" class="nav-link" data-scroll-target="#saving-and-writing-rds">3.5 Saving and Writing RDS</a></li>
  </ul></li>
  <li><a href="#visualizing-the-geospatial-data" id="toc-visualizing-the-geospatial-data" class="nav-link" data-scroll-target="#visualizing-the-geospatial-data">4. VISUALIZING THE GEOSPATIAL DATA</a>
  <ul class="collapse">
  <li><a href="#general" id="toc-general" class="nav-link" data-scroll-target="#general">GENERAL</a></li>
  <li><a href="#by-agency" id="toc-by-agency" class="nav-link" data-scroll-target="#by-agency">BY AGENCY</a></li>
  <li><a href="#by-vehicle" id="toc-by-vehicle" class="nav-link" data-scroll-target="#by-vehicle">BY VEHICLE</a></li>
  </ul></li>
  <li><a href="#calculating-nkde" id="toc-calculating-nkde" class="nav-link" data-scroll-target="#calculating-nkde">5. CALCULATING NKDE</a>
  <ul class="collapse">
  <li><a href="#nkde-fixed-bandwidth" id="toc-nkde-fixed-bandwidth" class="nav-link" data-scroll-target="#nkde-fixed-bandwidth">NKDE FIXED BANDWIDTH</a></li>
  <li><a href="#adaptive-bandwidth" id="toc-adaptive-bandwidth" class="nav-link" data-scroll-target="#adaptive-bandwidth">ADAPTIVE BANDWIDTH</a></li>
  </ul></li>
  <li><a href="#calculating-tknde" id="toc-calculating-tknde" class="nav-link" data-scroll-target="#calculating-tknde">6. CALCULATING TKNDE</a>
  <ul class="collapse">
  <li><a href="#per-month" id="toc-per-month" class="nav-link" data-scroll-target="#per-month">PER MONTH</a></li>
  <li><a href="#weekday" id="toc-weekday" class="nav-link" data-scroll-target="#weekday">WEEKDAY</a></li>
  </ul></li>
  <li><a href="#spatio-temporal-analysis" id="toc-spatio-temporal-analysis" class="nav-link" data-scroll-target="#spatio-temporal-analysis">7. SPATIO-TEMPORAL ANALYSIS</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Take-Home Exercise 1</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lorielle Malveda </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 9, 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">October 13, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>1. OVERVIEW</h1>
<p>Thailand has some of the most dangerous roads in the world, with around 20,000 people dying in road accidents each year—about 56 deaths a day, according to the World Health Organization (WHO). This makes road safety a critical issue in the country. Geospatial analytics can help by mapping where accidents happen, what types of roads are most dangerous, and identifying risk factors. By using this data, authorities can focus on improving dangerous areas, making roads safer, and planning better traffic enforcement. In a country with such high accident rates, geospatial analysis is a powerful tool to help reduce fatalities and protect lives.</p>
<p>This Take-Home Exercise attempts to:</p>
<ul>
<li><p>Visualize the <strong>spatio-temporal dynamics</strong> of road traffic accidents in BMR using appropriate statistical graphics and geovisualization methods.</p></li>
<li><p>Conduct <strong>detailed</strong> <strong>spatial analysis</strong> of road traffic accidents using appropriate Network Spatial Point Patterns Analysis methods.</p></li>
<li><p>To conduct <strong>detailed spatio-temporal analysis</strong> of road traffic accidents using appropriate Temporal Network Spatial Point Patterns Analysis methods.</p></li>
</ul>
</section>
<section id="getting-started" class="level1">
<h1>2. GETTING STARTED</h1>
<section id="installing-the-r-packages" class="level2">
<h2 class="anchored" data-anchor-id="installing-the-r-packages">2.1 Installing the R Packages</h2>
<p>This code chunk uses <code>p_load()</code> of the <strong><em>pacman</em></strong> package (stands for Package Manager) to check if the following packages are installed in the computer. The packages will then be launched into R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(sf, tidyverse, tmap, ggplot2, ggstatsplot, dplyr, spatstat, raster, readxl, spNetwork, rgeos, future, future.apply, RColorBrewer, RcppArmadillo, classInt, viridis, gifski, magma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="importing-the-datasets" class="level2">
<h2 class="anchored" data-anchor-id="importing-the-datasets">2.2 Importing the Datasets</h2>
<p>This Take-Home Exercise will utilize 3 datasets. They are:</p>
<ul>
<li><p><a href="https://www.kaggle.com/datasets/thaweewatboy/thailand-road-accident-2019-2022">Thailand Road Accident [2019-2022]</a> on Kaggle</p></li>
<li><p><a href="https://data.humdata.org/dataset/hotosm_tha_roads">Thailand Roads (OpenStreetMap Export)</a> on HDX.</p></li>
<li><p><a href="https://data.humdata.org/dataset/cod-ab-tha?">Thailand - Subnational Administrative Boundaries</a> on HDX.</p></li>
</ul>
<p>Let’s use the <strong><em>sf</em></strong> package to import the datasets as <strong><em>sf</em></strong> data frames.</p>
<section id="boundaries-data" class="level3">
<h3 class="anchored" data-anchor-id="boundaries-data">BOUNDARIES DATA</h3>
<p>Let’s import the boundaries data using the code chunk below. This will filter out the boundaries in the different provinces under the Bangkok Metropolitan Region.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>boundaries <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"data/tha_adm_rtsd_itos_20210121_shp"</span>, <span class="at">layer =</span> <span class="st">"tha_admbnda_adm1_rtsd_20220121"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ADM1_EN <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'Bangkok'</span>, <span class="st">'Samut Prakan'</span>, <span class="st">'Pathum Thani'</span>, <span class="st">'Nonthaburi'</span>, <span class="st">'Nakhon Pathom'</span>, <span class="st">'Samut Sakhon'</span> ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="road-accident-data" class="level3">
<h3 class="anchored" data-anchor-id="road-accident-data">ROAD ACCIDENT DATA</h3>
<p>This code chunk reads the CSV file of road accident data for Thailand. It filters out rows with missing or empty longitude and latitude values and then keeps only accidents that occurred in specific provinces around the Bangkok Metropolitan Region.</p>
<p>It then converts the data into a spatial object (<code>sf</code>), assigning geographic coordinates (longitude and latitude) in the WGS 84 coordinate system (EPSG:4326) and transforms it to UTM zone 47N (EPSG:32647) for further spatial analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rdacc_sf <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/thai_road_accident_2019_2022.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude) <span class="sc">&amp;</span> longitude <span class="sc">!=</span> <span class="st">""</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(latitude) <span class="sc">&amp;</span> latitude <span class="sc">!=</span><span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(province_en <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'Bangkok'</span>, <span class="st">'Samut Prakan'</span>, <span class="st">'Pathum Thani'</span>, <span class="st">'Nonthaburi'</span>, <span class="st">'Nakhon Pathom'</span>, <span class="st">'Samut Sakhon'</span> )) <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords=</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">crs=</span><span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">32647</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="road-network-data" class="level3">
<h3 class="anchored" data-anchor-id="road-network-data">ROAD NETWORK DATA</h3>
<p>Next dataset we will import is the road network data.</p>
<p>I filtered the road data based on a list of highway classifications from the <a href="https://wiki.openstreetmap.org/wiki/WikiProject_Thailand#Highway_classification">WikiProject Thailand page</a>, which includes road types such as ‘motorway,’ ‘trunk,’ ‘primary,’ and others. I chose only the highways which provide access to various types of vehicles, including motorcars, motorcycles, goods vehicles, heavy goods vehicles (HGV), and public service vehicles (PSV).</p>
<p><img src="images/Screenshot 2024-09-20 120938-01.png" class="img-fluid"></p>
<p><img src="images/Screenshot 2024-09-21 223326.png" class="img-fluid"></p>
<p>Loading this dataset shows that there are 1551498 records. That’s a lot! Let us check which ones to remove in the next section.</p>
<p>Note! To conserve space during rendering and when committing changes, I have included only images of some of the code implementations.</p>
</section>
</section>
</section>
<section id="geospatial-data-wrangling" class="level1">
<h1>3. GEOSPATIAL DATA WRANGLING</h1>
<section id="changing-coordinate-systems" class="level2">
<h2 class="anchored" data-anchor-id="changing-coordinate-systems">3.1 CHANGING COORDINATE SYSTEMS</h2>
<p>This code first sets the coordinate reference system (CRS) of the <code>throad</code> dataset to EPSG:4326 (WGS 84), which is a common geographic coordinate system. Then, both the <code>throad</code> and <code>boundaries</code> datasets are transformed to the UTM Zone 47N projection (EPSG:32647), which is a local projection for Thailand that is suitable for spatial analysis and accurate distance measurements. This ensures that both datasets are in the same CRS for further spatial operations.</p>
<p>We have also done this at the start when we created <code>rdacc_sf</code>.</p>
<p><img src="images/Screenshot 2024-09-21 224633.png" class="img-fluid"></p>
</section>
<section id="road-accident-data-1" class="level2">
<h2 class="anchored" data-anchor-id="road-accident-data-1">3.2 ROAD ACCIDENT DATA</h2>
<p>Let’s check the number of road accidents in each province listed in the <code>province_en</code> column of the <code>rdacc_sf</code> dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>rdacc_sf <span class="sc">%&gt;%</span> <span class="fu">count</span>(province_en)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I am selecting Bangkok for analysis because it has a comparably higher number of road accidents (6,089) compared to other provinces, such as Samut Prakan (2,241) and Nakhon Pathom (891).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>rdacc_sf <span class="ot">&lt;-</span> rdacc_sf <span class="sc">%&gt;%</span>       </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(province_en <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'Bangkok'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="boundaries-data-1" class="level2">
<h2 class="anchored" data-anchor-id="boundaries-data-1">3.3 BOUNDARIES DATA</h2>
<p>Since we have already filtered the accident data to only include Bangkok, this boundary dataset must also be filtered to Bangkok to ensure consistency in the analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>boundaries <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"data/tha_adm_rtsd_itos_20210121_shp"</span>, <span class="at">layer =</span> <span class="st">"tha_admbnda_adm1_rtsd_20220121"</span>) <span class="sc">%&gt;%</span>   <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(geometry)) <span class="sc">%&gt;%</span>   <span class="fu">filter</span>(ADM1_EN <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'Bangkok'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="road-network-data-1" class="level2">
<h2 class="anchored" data-anchor-id="road-network-data-1">3.4 ROAD NETWORK DATA</h2>
<p>Based on the data, the category that stands out is <strong>residential</strong>, containing over 1 million records, while the others, typically classified as highways without many walkroads, have significantly fewer records.</p>
<p><img src="images/Screenshot 2024-09-21 224159.png" class="img-fluid"></p>
<p>To further analyze this, we will check which areas have more accidents by applying a buffer to these road types.</p>
<p>Basically, the goal is to check whether accidents involve accidents TO PEOPLE vs accidents BETWEEN VEHICLES.</p>
<p><img src="images/Screenshot 2024-09-21 224716.png" class="img-fluid"></p>
<p>The code chunk below performs a spatial join, specifically an intersection between the road network (<code>throad</code> and <code>throad_residential</code>)and the boundaries (<code>boundaries</code>) dataset. This will return only the parts of the road network that are within the <code>boundaries</code> (which is filtered to only “Bangkok”).</p>
<p>Essentially, this step ensures that only the roads within Bangkok are retained, and any road segments outside the specified boundaries are excluded from the result stored in <code>diff</code> and <code>diff_residential.</code></p>
<p><img src="images/Screenshot 2024-09-21 224757.png" class="img-fluid"></p>
<p>Checking the buffer for accidents in both expressway (non-residential) and residential areas reveals that <strong>non-residential areas have around 6,075 accidents</strong>, while <strong>residential areas have around 2,397 accidents</strong>. This indicates that there are significantly more accidents occurring near expressways compared to residential areas, suggesting that high-traffic roads, such as expressways, may be more prone to accidents despite the higher population density in residential zones.</p>
<p><img src="images/clipboard-3840073253.png" class="img-fluid"></p>
<p>Let’s use <code>diff</code> and not <code>diff_residential</code> in the calculation of NKDE and TKNDE, meaning we are not using residential data to check for hotspot areas for traffic accidents in Bangkok.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>throad_filtered <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"data/hotosm_tha_roads_lines_shp"</span>, <span class="at">layer =</span> <span class="st">"hotosm_tha_roads_lines_shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(highway <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'motorway'</span>, <span class="st">'motorway_link'</span>, <span class="st">'trunk'</span>, <span class="st">'trunk_link'</span>, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'primary'</span>, <span class="st">'primary_link'</span>, <span class="st">'secondary'</span>, <span class="st">'secondary_link'</span>, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'tertiary'</span>, <span class="st">'tertiary_link'</span>, <span class="st">'unclassified'</span>, <span class="st">'living_street'</span>, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'road'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>throad_filtered <span class="ot">&lt;-</span> <span class="fu">st_set_crs</span>(throad_filtered, <span class="dv">4326</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>throad_filtered <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(throad_filtered, <span class="dv">32647</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>boundaries <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(boundaries, <span class="dv">32647</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(throad_filtered, boundaries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the next two code chunks, they provide additional insights and essentially emphasize the greater need to focus on non-residential areas, rather than residential ones, as they highlight the higher frequency of accidents in these high-traffic regions. This suggests that focusing on expressways and similar roads may yield more actionable insights than studying residential areas.</p>
</section>
<section id="saving-and-writing-rds" class="level2">
<h2 class="anchored" data-anchor-id="saving-and-writing-rds">3.5 Saving and Writing RDS</h2>
<p>I used <code>readRDS</code> and <code>writeRDS</code> functions to efficiently manage and preserve the exact state of R objects, ensuring that all attributes such as data types and row names are maintained accurately across sessions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(diff, <span class="st">"diff.rds"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(rdacc_sf, <span class="st">"rdacc_sf.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"diff.rds"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>rdacc_sf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"rdacc_sf.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="visualizing-the-geospatial-data" class="level1">
<h1>4. VISUALIZING THE GEOSPATIAL DATA</h1>
<section id="general" class="level2">
<h2 class="anchored" data-anchor-id="general">GENERAL</h2>
<p>This is our final geospatial data before calculating NKDE and TNKDE. This code sets the tmap mode to interactive viewing and visualizes the road segments (<code>diff</code>) in purple and the accident points (<code>rdacc_sf</code>) in yellow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">'view'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(diff) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">col=</span><span class="st">"lightblue"</span>, <span class="at">size=</span><span class="fl">0.02</span>)<span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(rdacc_sf) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col=</span><span class="st">"blue"</span>, <span class="at">size=</span><span class="fl">0.02</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="by-agency" class="level2">
<h2 class="anchored" data-anchor-id="by-agency">BY AGENCY</h2>
<p>Based on the map, when visualizing accidents by agency, it is clear that most are reported under the agency of the Department of Highways. In terms of policy creation and implementation, this suggests that the government can focus more on these roads and the agency’s involvement. Additionally, there is an apparent concentration of roads specific to this agency, which could be a point of investigation to understand why accidents are primarily occurring on these roads and how they can be addressed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(diff) <span class="sc">+</span>   </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">col =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(rdacc_sf) <span class="sc">+</span>   </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"agency"</span>, <span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">size =</span> <span class="fl">0.02</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="by-vehicle" class="level2">
<h2 class="anchored" data-anchor-id="by-vehicle">BY VEHICLE</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(diff) <span class="sc">+</span>   </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">col =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(rdacc_sf) <span class="sc">+</span>   </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"vehicle_type"</span>, <span class="at">palette =</span> <span class="st">"Set1"</span>, <span class="at">size =</span> <span class="fl">0.02</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>We can observe that certain colors stand out on the map, indicating potential patterns in vehicle-related accidents. The <strong>pink dots</strong>, representing private/passenger cars, are scattered across different areas, while the <strong>yellow dots</strong>, representing motorized tricycles (commonly known as <strong>tuk tuks</strong>, which are famous among tourists for being fast vehicles), are concentrated in the central region. This may be due to the presence of tourist spots and high-traffic areas. Given their speed, tuk tuks may have a higher chance of being involved in accidents.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Tuktuk_at_Tha_Phae_Road.jpg" class="img-fluid figure-img"></p>
<figcaption>Image of a Tuk Tuk</figcaption>
</figure>
</div>
<p>Similarly, the <strong>orange dots</strong>, representing motorcycles, are concentrated in the southern part of the map. These observations suggest that certain vehicle types may be more prone to accidents in specific areas, which warrants further investigation.</p>
</section>
</section>
<section id="calculating-nkde" class="level1">
<h1>5. CALCULATING NKDE</h1>
<p>Let’s now calculate the NKDE to potentially identify hotspot areas that have high concentrations of traffic road accidents along the Bangkok City road network. We hope to specify network segments that may require attention or intervention.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>lixels <span class="ot">&lt;-</span> <span class="fu">lixelize_lines</span>(sf<span class="sc">::</span><span class="fu">st_cast</span>(diff, <span class="st">"LINESTRING"</span>),<span class="dv">750</span>,<span class="at">mindist =</span> <span class="dv">375</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">lines_center</span>(lixels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="nkde-fixed-bandwidth" class="level2">
<h2 class="anchored" data-anchor-id="nkde-fixed-bandwidth">NKDE FIXED BANDWIDTH</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>bws_selection_cv <span class="ot">&lt;-</span> <span class="fu">bw_cv_likelihood_calc</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">bws =</span> <span class="fu">seq</span>(<span class="dv">1000</span>,<span class="dv">4000</span>,<span class="dv">100</span>),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">lines =</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(diff, <span class="st">"LINESTRING"</span>), <span class="at">events =</span> rdacc_sf,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">w =</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">nrow</span>(rdacc_sf)),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernel_name =</span> <span class="st">"quartic"</span>, <span class="at">method =</span> <span class="st">"discontinuous"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">diggle_correction =</span> <span class="cn">FALSE</span>, <span class="at">study_area =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> <span class="dv">8</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits=</span><span class="dv">2</span>, <span class="at">tol=</span><span class="fl">0.1</span>, <span class="at">agg=</span><span class="dv">5</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">sparse=</span><span class="cn">TRUE</span>, <span class="at">grid_shape=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose=</span><span class="cn">FALSE</span>, <span class="at">check=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(bws_selection_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">bw</th>
<th style="text-align: right;">cv_scores</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1000</td>
<td style="text-align: right;">-26.02321</td>
</tr>
<tr class="even">
<td style="text-align: right;">1100</td>
<td style="text-align: right;">-24.64536</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1200</td>
<td style="text-align: right;">-23.60505</td>
</tr>
<tr class="even">
<td style="text-align: right;">1300</td>
<td style="text-align: right;">-22.89627</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1400</td>
<td style="text-align: right;">-22.40751</td>
</tr>
<tr class="even">
<td style="text-align: right;">1500</td>
<td style="text-align: right;">-21.35188</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1600</td>
<td style="text-align: right;">-21.08328</td>
</tr>
<tr class="even">
<td style="text-align: right;">1700</td>
<td style="text-align: right;">-20.81262</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1800</td>
<td style="text-align: right;">-20.64961</td>
</tr>
<tr class="even">
<td style="text-align: right;">1900</td>
<td style="text-align: right;">-20.14787</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2000</td>
<td style="text-align: right;">-20.20357</td>
</tr>
<tr class="even">
<td style="text-align: right;">2100</td>
<td style="text-align: right;">-19.58824</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2200</td>
<td style="text-align: right;">-19.18807</td>
</tr>
<tr class="even">
<td style="text-align: right;">2300</td>
<td style="text-align: right;">-19.01187</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2400</td>
<td style="text-align: right;">-18.72223</td>
</tr>
<tr class="even">
<td style="text-align: right;">2500</td>
<td style="text-align: right;">-18.54543</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2600</td>
<td style="text-align: right;">-18.58922</td>
</tr>
<tr class="even">
<td style="text-align: right;">2700</td>
<td style="text-align: right;">-18.52070</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2800</td>
<td style="text-align: right;">-18.56302</td>
</tr>
<tr class="even">
<td style="text-align: right;">2900</td>
<td style="text-align: right;">-18.60437</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3000</td>
<td style="text-align: right;">-18.64468</td>
</tr>
<tr class="even">
<td style="text-align: right;">3100</td>
<td style="text-align: right;">-18.68396</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3200</td>
<td style="text-align: right;">-18.72223</td>
</tr>
<tr class="even">
<td style="text-align: right;">3300</td>
<td style="text-align: right;">-18.64742</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3400</td>
<td style="text-align: right;">-18.46054</td>
</tr>
<tr class="even">
<td style="text-align: right;">3500</td>
<td style="text-align: right;">-18.38194</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3600</td>
<td style="text-align: right;">-18.41571</td>
</tr>
<tr class="even">
<td style="text-align: right;">3700</td>
<td style="text-align: right;">-18.44907</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3800</td>
<td style="text-align: right;">-18.48170</td>
</tr>
<tr class="even">
<td style="text-align: right;">3900</td>
<td style="text-align: right;">-18.40188</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4000</td>
<td style="text-align: right;">-18.43267</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In this code, <strong>future::plan(future::multisession(workers=2))</strong> is used to enable parallel processing, allowing the NKDE calculation to run on two separate cores (workers). This speeds up the computation by distributing the workload across multiple processors, which is particularly useful when working with large datasets and complex calculations like NKDE.</p>
<p>The method = “continuous” is selected because it offers the best of both worlds by providing a smooth and seamless density estimation along the road network while still capturing the detailed distribution of accidents. It ensures that there are no artificial breaks between road segments, making the analysis more accurate and realistic in representing how accidents occur across the network.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(future<span class="sc">::</span><span class="fu">multisession</span>(<span class="at">workers=</span><span class="dv">2</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>densities_mc <span class="ot">&lt;-</span> <span class="fu">nkde.mc</span>(sf<span class="sc">::</span><span class="fu">st_cast</span>(diff, <span class="st">"LINESTRING"</span>),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">events =</span> rdacc_sf,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">w =</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">nrow</span>(rdacc_sf)),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">samples =</span> samples,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">kernel_name =</span> <span class="st">"quartic"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">bw =</span> <span class="dv">3500</span>, <span class="at">div=</span> <span class="st">"bw"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">method =</span> <span class="st">"continuous"</span>, </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">digits =</span> <span class="dv">1</span>, <span class="at">tol =</span> <span class="dv">1</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">grid_shape =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">max_depth =</span> <span class="dv">8</span>,<span class="at">agg =</span> <span class="dv">10</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">sparse =</span> <span class="cn">TRUE</span>,<span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(future<span class="sc">::</span><span class="fu">plan</span>(), <span class="st">"sequential"</span>)) future<span class="sc">::</span><span class="fu">plan</span>(future<span class="sc">::</span>sequential)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>density <span class="ot">&lt;-</span> densities_mc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>samples<span class="sc">$</span>density <span class="ot">&lt;-</span> samples<span class="sc">$</span>density<span class="sc">*</span><span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>samples2 <span class="ot">&lt;-</span> samples[<span class="fu">order</span>(samples<span class="sc">$</span>density),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>colorRamp <span class="ot">&lt;-</span> <span class="fu">brewer.pal</span>(<span class="at">n =</span> <span class="dv">7</span>, <span class="at">name =</span> <span class="st">"Spectral"</span>) </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>colorRamp <span class="ot">&lt;-</span> <span class="fu">rev</span>(colorRamp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">'view'</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(diff) <span class="sc">+</span>    </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="st">"black"</span>)<span class="sc">+</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(samples2) <span class="sc">+</span>   </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"density"</span>, <span class="at">style =</span> <span class="st">"kmeans"</span>, <span class="at">palette =</span> colorRamp, <span class="at">n =</span> <span class="dv">7</span>, <span class="at">size =</span> <span class="fl">0.04</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2024-09-22 194349.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>The plot above reveals several red areas, indicating locations with a higher concentration of accidents. Upon closer inspection, many of these high-density areas are located at or near intersections, suggesting that intersections may be key hotspots for accidents. This highlights the need for further investigation into intersection safety and potential improvements in traffic management at these critical points.</p>
</section>
<section id="adaptive-bandwidth" class="level2">
<h2 class="anchored" data-anchor-id="adaptive-bandwidth">ADAPTIVE BANDWIDTH</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>adapt_densities <span class="ot">&lt;-</span> <span class="fu">nkde.mc</span>( <span class="at">lines =</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(diff, <span class="st">"LINESTRING"</span>), </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">events =</span> rdacc_sf, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">w =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(rdacc_sf)), </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">samples =</span> samples, </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">kernel_name =</span> <span class="st">"quartic"</span>, </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">bw =</span> <span class="dv">3500</span>, <span class="at">div =</span> <span class="st">"bw"</span>, </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                            <span class="at">adaptive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">trim_bw =</span> <span class="dv">1000</span>, </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">method =</span> <span class="st">"discontinuous"</span>, </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">digits =</span> <span class="dv">1</span>, <span class="at">tol =</span> <span class="dv">5</span>, </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">grid_shape =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">max_depth =</span> <span class="dv">16</span>, <span class="at">agg =</span> <span class="dv">5</span>, </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sparse =</span> <span class="cn">TRUE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span> )</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(adapt_densities<span class="sc">$</span>k) <span class="sc">==</span> <span class="fu">nrow</span>(samples)) {</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  samples<span class="sc">$</span>density <span class="ot">&lt;-</span> adapt_densities<span class="sc">$</span>k } <span class="cf">else</span> { <span class="fu">stop</span>(<span class="st">"Mismatch between density results and number of samples. Please check the input data."</span>) }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(diff) <span class="sc">+</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="st">"black"</span>)<span class="sc">+</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(samples) <span class="sc">+</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="st">"density"</span>, <span class="at">style =</span> <span class="st">"kmeans"</span>, <span class="at">palette =</span> colorRamp, <span class="at">n =</span> <span class="dv">7</span>, <span class="at">size =</span> <span class="fl">0.04</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/Screenshot 2024-09-22 204345.png" class="img-fluid"></p>
<p>In the adaptive bandwidth density plot, no red areas are observed, indicating that the density of accidents is more evenly distributed. The adaptive bandwidth adjusts to local conditions, smoothing the density in areas with fewer accidents and concentrating on high-density areas, which may explain the absence of extreme hotspots. This approach provides a more balanced view of accident distribution across the network, but it may also mask the intensity of certain critical areas, such as intersections, which were more visible in the fixed bandwidth plot.</p>
</section>
</section>
<section id="calculating-tknde" class="level1">
<h1>6. CALCULATING TKNDE</h1>
<p>Let’s now explore the temporal dimensions of the data. We’ll begin by performing some data wrangling to prepare it for analysis, such as adding datetime information and separating it into date, month, and weekday components. 6. CALCULATING TKNDE</p>
<p>Let’s now explore the temporal dimensions of the data. We’ll begin by performing some data wrangling to prepare it for analysis, such as adding datetime information and separating it into date, month, and weekday components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>rdacc_sf<span class="sc">$</span>Date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(rdacc_sf<span class="sc">$</span>incident_datetime)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2019-01-01"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>rdacc_sf<span class="sc">$</span>difftime <span class="ot">&lt;-</span> <span class="fu">difftime</span>(rdacc_sf<span class="sc">$</span>Date, start, <span class="at">units =</span> <span class="st">"days"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>rdacc_sf<span class="sc">$</span>difftime <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(rdacc_sf<span class="sc">$</span>difftime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(rdacc_sf<span class="sc">$</span>incident_datetime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(rdacc_sf<span class="sc">$</span>incident_datetime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="per-month" class="level2">
<h2 class="anchored" data-anchor-id="per-month">PER MONTH</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>months <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>) </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>months <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nchar</span>(months)<span class="sc">==</span><span class="dv">1</span>, <span class="fu">paste0</span>(<span class="st">"0"</span>, months), months) </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>months_starts_labs <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"2019/"</span>,months,<span class="st">"/01"</span>, <span class="at">sep =</span> <span class="st">""</span>) </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>months_starts_num <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(months_starts_labs, <span class="at">format =</span> <span class="st">"%Y/%m/%d"</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>months_starts_num <span class="ot">&lt;-</span> <span class="fu">difftime</span>(months_starts_num, start, <span class="at">units =</span> <span class="st">"days"</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>months_starts_num <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(months_starts_num) </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>months_starts_labs <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"2019/"</span>, <span class="st">""</span>, months_starts_labs, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>rdacc_sf<span class="sc">$</span>high_fatalities <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(rdacc_sf<span class="sc">$</span>number_of_fatalities <span class="sc">&gt;=</span> <span class="dv">1</span>, <span class="st">"High"</span>, <span class="st">"Low"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The plot below shows accidents per month.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rdacc_sf) <span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> difftime), <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> months_starts_num, <span class="at">labels =</span> months_starts_labs,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">limits =</span> <span class="fu">c</span>(<span class="fu">min</span>(months_starts_num), <span class="fu">max</span>(months_starts_num)),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>) ) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Accidents per Month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on the histogram, January appears to have the highest number of accidents, with notable peaks also in April and July. In contrast, December shows a lower frequency of accidents. These trends might reflect seasonal or behavioral patterns that influence road safety throughout the year.</p>
<p>The high number of accidents in January may be linked to New Year celebrations, while the peaks in April could be associated with Songkran, Thailand’s water festival, which is known for increased travel and festivities. The lower number of accidents in December might reflect reduced activity as the year comes to a close.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rdacc_sf) <span class="sc">+</span>    </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> difftime, <span class="at">fill =</span> high_fatalities), <span class="at">bins =</span> <span class="dv">30</span>, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span>    </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(     <span class="at">breaks =</span> months_starts_num,      </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">labels =</span> months_starts_labs,      </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">limits =</span> <span class="fu">c</span>(<span class="fu">min</span>(months_starts_num), </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">max</span>(months_starts_num)),     </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)   ) <span class="sc">+</span>   </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"High"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Low"</span> <span class="ot">=</span> <span class="st">"blue"</span>)) <span class="sc">+</span>    </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Although the number of fatalities is relatively small compared to non-fatal accidents, each loss of life is significant. The map below highlights the areas where fatalities have occurred, emphasizing the importance of addressing these critical locations to improve road safety and save lives.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fatalities_data <span class="ot">&lt;-</span> rdacc_sf <span class="sc">%&gt;%</span>   </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(number_of_fatalities <span class="sc">&gt;</span> <span class="dv">0</span>)  </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"view"</span>) </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(fatalities_data) <span class="sc">+</span>   </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span>   </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">title =</span> <span class="st">"Locations with Fatalities"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare weights and temporal samples</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(rdacc_sf))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>samples_temporal <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(rdacc_sf<span class="sc">$</span>difftime), <span class="fl">0.5</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate temporal kernel density estimates at multiple bandwidths</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>time_kernel_values <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_10 =</span> <span class="fu">tkde</span>(rdacc_sf<span class="sc">$</span>difftime, <span class="at">w =</span> w, <span class="at">samples =</span> samples_temporal, <span class="at">bw =</span> <span class="dv">10</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_20 =</span> <span class="fu">tkde</span>(rdacc_sf<span class="sc">$</span>difftime, <span class="at">w =</span> w, <span class="at">samples =</span> samples_temporal, <span class="at">bw =</span> <span class="dv">20</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_30 =</span> <span class="fu">tkde</span>(rdacc_sf<span class="sc">$</span>difftime, <span class="at">w =</span> w, <span class="at">samples =</span> samples_temporal, <span class="at">bw =</span> <span class="dv">30</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_40 =</span> <span class="fu">tkde</span>(rdacc_sf<span class="sc">$</span>difftime, <span class="at">w =</span> w, <span class="at">samples =</span> samples_temporal, <span class="at">bw =</span> <span class="dv">40</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_50 =</span> <span class="fu">tkde</span>(rdacc_sf<span class="sc">$</span>difftime, <span class="at">w =</span> w, <span class="at">samples =</span> samples_temporal, <span class="at">bw =</span> <span class="dv">50</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw_60 =</span> <span class="fu">tkde</span>(rdacc_sf<span class="sc">$</span>difftime, <span class="at">w =</span> w, <span class="at">samples =</span> samples_temporal, <span class="at">bw =</span> <span class="dv">60</span>, <span class="at">kernel_name =</span> <span class="st">"quartic"</span>),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> samples_temporal</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape data for plotting</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>df_time <span class="ot">&lt;-</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(time_kernel_values, <span class="at">id.vars =</span> <span class="st">"time"</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>df_time<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_time<span class="sc">$</span>variable)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting kernel density estimates</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df_time) <span class="sc">+</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> months_starts_num, </span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> months_starts_labs,</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="fu">min</span>(months_starts_num), <span class="fu">max</span>(months_starts_num))</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vars</span>(variable), </span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="dv">2</span>, </span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free"</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The series of plots above depict temporal kernel density estimates of road accidents in Thailand over a year, differentiated by various bandwidth settings from 10 to 60. The varying bandwidths reveal different levels of data smoothness, where smaller bandwidths capture more abrupt fluctuations in accident occurrences, potentially highlighting seasonal spikes or specific events. Larger bandwidths smooth out these details, indicating broader trends, such as increased accidents during peak tourist seasons or major festivals like Songkran, which are obscured in higher bandwidth plots.</p>
</section>
<section id="weekday" class="level2">
<h2 class="anchored" data-anchor-id="weekday">WEEKDAY</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>rdacc_sf<span class="sc">$</span>day_of_week <span class="ot">&lt;-</span> <span class="fu">weekdays</span>(<span class="fu">as.Date</span>(rdacc_sf<span class="sc">$</span>incident_datetime))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>rdacc_sf<span class="sc">$</span>day_of_week <span class="ot">&lt;-</span> <span class="fu">factor</span>(rdacc_sf<span class="sc">$</span>day_of_week, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Monday"</span>, <span class="st">"Tuesday"</span>, <span class="st">"Wednesday"</span>, <span class="st">"Thursday"</span>, <span class="st">"Friday"</span>, <span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In terms of accidents per day of the week, the data shows that Fridays and Saturdays have the highest number of incidents. This could be due to increased traffic and social activities during the weekend, contributing to higher accident rates on these days. Understanding these trends can help target road safety measures more effectively during high-risk periods.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rdacc_sf) <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">x =</span> day_of_week), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day of the Week"</span>, <span class="at">y =</span> <span class="st">"Number of Accidents"</span>) <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span><span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="spatio-temporal-analysis" class="level1">
<h1>7. SPATIO-TEMPORAL ANALYSIS</h1>
<p>Now let’s head on to spatio-temporal analysis.</p>
<p>According to the “leave-one-out cross-validation” method, the optimal bandwidth settings are determined to be 4000 meters and 70 days. This is based on the <code>cv_scores</code> result below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>cv_scores <span class="ot">&lt;-</span> <span class="fu">bw_tnkde_cv_likelihood_calc</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">bws_net =</span> <span class="fu">seq</span>(<span class="dv">2500</span>, <span class="dv">4000</span>, <span class="at">by =</span> <span class="dv">100</span>),</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">bws_time =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">70</span>, <span class="at">by =</span> <span class="dv">10</span>),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lines =</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(diff, <span class="st">"LINESTRING"</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">events =</span> rdacc_sf,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_field =</span> <span class="st">"difftime"</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">w =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(rdacc_sf)),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernel_name =</span> <span class="st">"quartic"</span>,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"continuous"</span>,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">diggle_correction =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">study_area =</span> <span class="cn">NULL</span>,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_depth =</span> <span class="dv">10</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">2</span>,<span class="at">tol =</span> <span class="fl">0.1</span>,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">agg =</span> <span class="dv">10</span>,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">sparse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid_shape =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">sub_sample =</span> <span class="dv">1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">check =</span> <span class="cn">TRUE</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on this, the optimal set of bandwidths is 4000m and 70 days.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2024-09-22 221432.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>The code first defines a sequence of sample times from 0 to the maximum difference in time (<code>difftime</code>) in increments of 10, which is used for temporal analysis of road accidents in <code>rdacc_sf</code>. Then, it employs the tnkde function to perform a spatio-temporal kernel density estimation on road network data, utilizing the defined sample times and locations (samples) to calculate densities, adjusting for both space (<code>bw_net</code>) and time (<code>bw_time</code>) with an adaptive approach to better capture the density patterns over the network and time. The inputs are from the method we used above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>sample_time <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(rdacc_sf<span class="sc">$</span>difftime), <span class="at">by =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>tnkde_densities <span class="ot">&lt;-</span> <span class="fu">tnkde</span>( <span class="at">lines =</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(diff, <span class="st">"LINESTRING"</span>), </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">events =</span> rdacc_sf, </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time_field =</span> <span class="st">"difftime"</span>, </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">w =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(rdacc_sf)), </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">samples_loc =</span> samples, </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">samples_time =</span> sample_time, </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">kernel_name =</span> <span class="st">"quartic"</span>, </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">bw_net =</span> <span class="dv">4000</span>, <span class="at">bw_time =</span> <span class="dv">70</span>, </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">adaptive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">trim_bw_net =</span> <span class="dv">900</span>, </span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">trim_bw_time =</span> <span class="dv">80</span>, </span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">method =</span> <span class="st">"discontinuous"</span>, </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">div =</span> <span class="st">"bw"</span>, <span class="at">max_depth =</span> <span class="dv">10</span>, </span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">tol =</span> <span class="fl">0.01</span>, </span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">agg =</span> <span class="dv">15</span>, <span class="at">grid_shape =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="at">verbose =</span> <span class="cn">FALSE</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code chunks below will be used to visualize the spatio-temporal values compressed into a gif animation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>all_densities <span class="ot">&lt;-</span> <span class="fu">c</span>(tnkde_densities<span class="sc">$</span>k) </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>color_breaks <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(all_densities, <span class="at">n =</span> <span class="dv">10</span>, <span class="at">style =</span> <span class="st">"quantile"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(start)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>all_maps <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(tnkde_densities<span class="sc">$</span>k), <span class="cf">function</span>(i) {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  date <span class="ot">&lt;-</span> start_date <span class="sc">+</span> sample_time[i]  </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  samples<span class="sc">$</span>density <span class="ot">&lt;-</span> tnkde_densities<span class="sc">$</span>k[, i]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a> map1 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(samples) <span class="sc">+</span>  </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="st">"density"</span>, <span class="at">size =</span> <span class="fl">0.01</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">breaks =</span> color_breaks<span class="sc">$</span>brks, <span class="at">palette =</span> <span class="fu">viridis</span>(<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">legend.show =</span> <span class="cn">FALSE</span>, <span class="at">main.title =</span> <span class="fu">as.character</span>(date),</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">main.title.size =</span> <span class="fl">0.5</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(map1)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_animation</span>(all_maps, <span class="at">filename =</span> <span class="st">"images/animated_map.gif"</span>, </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">height =</span> <span class="dv">1000</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">delay =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating frames
=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Creating animation
Animation saved to C:\loriellemalveda\ISSS626-GAA\Take-home_Ex\Take-home_Ex01\images\animated_map.gif </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"images/animated_map.gif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/animated_map.gif" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In this animation, we observe the dynamic nature of hotspot locations over time. As the frames progress, you can clearly see how the hotspots shift, evolve, and sometimes even disappear.</p>
<p>This analysis has illustrated the complex interplay between space and time in the distribution of traffic accidents in Bangkok. The use of spatio-temporal kernel density estimation revealed that not only do the intensities of hotspots vary, but their locations also shift over time, reflecting underlying temporal trends that were not apparent in purely spatial analyses.</p>
<p>These are crucial for developing targeted strategies and interventions that are responsive to the temporal shifts in patterns, to ensure that resources are allocated efficiently and effectively.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>